name: "Setup Dependencies"
description: "Setup tools/dependencies"
inputs:
  install_task:
    description: "install task if true"
    default: "true"
  task_version:
    description: "version of task to install"
    default: "v3.44.0"

  install_terraform:
    description: "install terraform if true"
    default: "false"
  install_python:
    description: "install python if true"
    default: "false"
  service_path:
    description: "path to service within repo (used to find version file)"
    default: ""

runs:
  using: "composite"
  steps:
    - name: Install go-task
      if: ${{ inputs.install_task == 'true' }}
      uses: supplypike/setup-bin@1fafb085795af4a3f183502f3a9dffa8f7b83217 # v5.0.0
      with:
        uri: "https://github.com/go-task/task/releases/download/${{ inputs.task_version }}/task_linux_amd64.tar.gz"
        name: task
        version: ${{ inputs.task_version }}

    - name: Set up Terraform
      if: ${{ inputs.install_terraform == 'true' }}
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: 1.5.0

    - name: Terraform Init
      if: ${{ inputs.install_terraform == 'true' }}
      working-directory: infra
      shell: bash
      run: |
        terraform init \
          -backend-config="bucket=${{ env.aws-statefile-s3-bucket }}" \
          -backend-config="key=${{ github.event.repository.name }}" \
          -backend-config="region=${{ env.aws-region }}" \
          -backend-config="dynamodb_table=${{ env.aws-lock-dynamodb-table }}"

    - name: Terraform Validate
      if: ${{ inputs.install_terraform == 'true' }}
      shell: bash
      working-directory: infra
      run: terraform validate

    - name: Set up Python
      if: ${{ inputs.install_python == 'true' }}
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
        cache-dependency-path: ./${{ inputs.service_path }}/tests/requirements-tests.txt

    - name: Install dependencies
      if: ${{ inputs.install_python == 'true' }}
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install -r ./${{ inputs.service_path }}/tests/requirements-tests.txt
